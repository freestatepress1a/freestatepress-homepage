<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeState Press</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        
        h1, h2, h3, h4 {
            font-family: 'Roboto Slab', serif;
        }

        .header-bg {
            background-color: #020617;
        }

        .container-padding {
            padding: 1.5rem 1rem;
        }

        .nav-link {
            transition: color 0.3s ease;
        }

        .nav-link:hover {
            color: #94a3b8;
        }
        
        .article-card {
            border-left: 4px solid #3b82f6;
        }

        .cta-button {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
    <header class="header-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row items-center justify-between">
            <a href="#" class="flex items-center space-x-2">
                <!-- Updated the logo placeholder text, colors, and added a patriotic border -->
                <img src="https://placehold.co/40x40/0A234E/F5F5DC?text=FSP" alt="FreeState Press Logo" class="rounded-full w-10 h-10 object-cover border-2 border-red-600">
                <h1 class="text-3xl font-bold tracking-tight">FreeState Press</h1>
            </a>
            <nav class="mt-4 sm:mt-0">
                <ul class="flex space-x-6 text-gray-300 font-medium">
                    <li><a href="#" class="nav-link">Home</a></li>
                    <li><a href="#" class="nav-link">Politics</a></li>
                    <li><a href="#" class="nav-link">Sports</a></li>
                    <li><a href="#" class="nav-link">Technology</a></li>
                    <li><a href="#" class="nav-link">About</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Article Section -->
        <section class="lg:col-span-2">
            <div id="hero-article" class="bg-white rounded-xl shadow-lg p-6 flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6">
                <img src="https://placehold.co/600x400/e5e7eb/6b7280?text=News" alt="Hero Article Image" class="w-full md:w-1/2 rounded-lg object-cover">
                <div class="flex flex-col space-y-2">
                    <h2 class="text-3xl font-bold text-gray-900 leading-tight">Breaking: New Legislation to Impact Local Businesses</h2>
                    <p class="text-gray-500 font-medium text-sm">By Jane Doe - October 26, 2023</p>
                    <p class="text-gray-600 leading-relaxed">Local authorities are considering a new bill aimed at regulating small businesses. Experts weigh in on the potential effects on the local economy and community.</p>
                    <a href="#" class="text-blue-600 font-medium hover:underline">Read Full Article &rarr;</a>
                </div>
            </div>

            <h3 class="text-2xl font-bold text-gray-900 mt-8 mb-4">Latest Articles</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Article Card 1 -->
                <div class="bg-white rounded-xl shadow p-5 article-card">
                    <h4 class="text-xl font-bold text-gray-900">The Rise of Remote Work: A New Era for Offices</h4>
                    <p class="text-gray-500 text-sm mt-1">October 25, 2023</p>
                <p class="text-gray-600 mt-3">As companies embrace flexible work models, the traditional office space is undergoing a significant transformation. What does the future hold for corporate real estate?</p>
                </div>
                <!-- Article Card 2 -->
                <div class="bg-white rounded-xl shadow p-5 article-card">
                    <h4 class="text-xl font-bold text-gray-900">AI in Medicine: Revolutionizing Diagnostics</h4>
                    <p class="text-gray-500 text-sm mt-1">October 24, 2023</p>
                    <p class="text-gray-600 mt-3">Artificial intelligence is proving to be a game-changer in healthcare, with new systems able to analyze medical images with unprecedented accuracy.</p>
                </div>
            </div>
        </section>

        <!-- Right Sidebar Section -->
        <aside class="lg:col-span-1">
            <!-- Article Generator Section -->
            <section class="bg-gray-100 p-6 rounded-xl shadow-inner">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">Article Generator</h3>
                <p class="text-gray-600 mb-4">Enter a topic below to generate a new article with AI.</p>
                <form id="generate-article-form" class="space-y-4">
                    <div>
                        <label for="topic-input" class="sr-only">Enter Topic</label>
                        <input type="text" id="topic-input" placeholder="e.g., The Future of Electric Cars" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                    <button type="submit" id="generate-article-button" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md cta-button">Generate Article</button>
                    <div id="loading-spinner" class="hidden flex justify-center mt-4">
                        <div class="loading-spinner"></div>
                    </div>
                </form>
            </section>

            <!-- Generated Content Section -->
            <section id="generated-content" class="hidden mt-8">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 id="generated-headline" class="text-2xl font-bold text-gray-900 mb-2"></h3>
                    <p id="generated-summary" class="text-gray-600 leading-relaxed"></p>
                    <div class="mt-4 flex justify-end">
                        <button id="save-article-button" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md cta-button">Save Article</button>
                    </div>
                </div>
            </section>
            
            <!-- User ID and Saved Articles Section -->
            <section class="mt-8 bg-gray-100 p-6 rounded-xl shadow-inner">
                <h3 class="text-2xl font-bold text-gray-900 mb-2">My Saved Articles</h3>
                <p class="text-gray-600 mb-4 text-sm">
                    Your User ID: <span id="userIdDisplay" class="font-mono text-xs text-gray-500 break-all">Loading...</span>
                </p>
                <div id="saved-articles-list" class="space-y-4">
                    <!-- Saved articles will be rendered here dynamically -->
                </div>
            </section>
        </aside>
    </main>

    <footer class="bg-gray-900 text-gray-300 py-6 mt-10">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2023 FreeState Press. All rights reserved.</p>
        </div>
    </footer>

    <!-- BLOCK START: JavaScript Section -->
    <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase Setup ---
    // The following global variables are provided by the canvas environment.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, auth, db;
    let userId = null;

    // Initialize Firebase and handle authentication
    const initializeFirebase = async () => {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Listen for auth state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('userIdDisplay').textContent = userId;
                    // Listen for real-time article updates after successful sign-in
                    setupArticleListener();
                } else {
                    document.getElementById('userIdDisplay').textContent = 'Signed Out';
                }
            });

            // Sign in with the custom token or anonymously if no token is available
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            document.getElementById('userIdDisplay').textContent = 'Error';
        }
    };
    
    // Call the initialization function
    initializeFirebase();

    // --- Firestore Operations ---
    // Firestore path for user-specific data
    const getUserArticlesCollection = (userId) => {
        const path = `/artifacts/${appId}/users/${userId}/articles`;
        return collection(db, path);
    };

    // Save a generated article to Firestore
    const saveArticle = async (headline, content) => {
        if (!userId) {
            console.error("User not authenticated. Cannot save article.");
            return;
        }

        try {
            const docRef = await addDoc(getUserArticlesCollection(userId), {
                headline: headline,
                content: content,
                createdAt: serverTimestamp()
            });
            console.log("Article saved with ID: ", docRef.id);
        } catch (e) {
            console.error("Error adding document: ", e);
        }
    };

    // Set up a real-time listener for the user's articles
    const setupArticleListener = () => {
        if (!userId) return;

        const q = query(getUserArticlesCollection(userId));
        onSnapshot(q, (snapshot) => {
            const articlesList = document.getElementById('saved-articles-list');
            articlesList.innerHTML = ''; // Clear existing list

            if (snapshot.empty) {
                articlesList.innerHTML = '<p class="text-gray-500">No saved articles yet.</p>';
            } else {
                snapshot.forEach((doc) => {
                    const article = doc.data();
                    const articleCard = `
                        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-400">
                            <h4 class="font-bold text-lg text-gray-800">${article.headline}</h4>
                            <p class="text-sm text-gray-500 mt-1">${article.createdAt?.toDate().toLocaleDateString() || 'Just now'}</p>
                            <p class="text-gray-600 mt-2 line-clamp-2">${article.content}</p>
                            <button class="view-article-button text-blue-600 mt-2 hover:underline text-sm" data-id="${doc.id}">Read More</button>
                        </div>
                    `;
                    articlesList.innerHTML += articleCard;
                });

                // Attach click listeners to the "Read More" buttons
                articlesList.querySelectorAll('.view-article-button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const articleId = e.target.dataset.id;
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/articles`, articleId);
                        const docSnap = await getDoc(docRef);

                        if (docSnap.exists()) {
                            const article = docSnap.data();
                            document.getElementById('generated-content').classList.remove('hidden');
                            document.getElementById('generated-headline').textContent = article.headline;
                            document.getElementById('generated-summary').textContent = article.content;
                            document.getElementById('save-article-button').style.display = 'none'; // Hide the save button for loaded articles
                        } else {
                            console.error("No such document!");
                        }
                    });
                });
            }
        });
    };
    
    // --- API and UI Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        const generateForm = document.getElementById('generate-article-form');
        const topicInput = document.getElementById('topic-input');
        const generateButton = document.getElementById('generate-article-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const generatedContent = document.getElementById('generated-content');
        const generatedHeadline = document.getElementById('generated-headline');
        const generatedSummary = document.getElementById('generated-summary');
        const saveArticleButton = document.getElementById('save-article-button');

        // Handle the save button click
        saveArticleButton.addEventListener('click', () => {
            const headline = generatedHeadline.textContent;
            const content = generatedSummary.textContent;
            saveArticle(headline, content);
            saveArticleButton.style.display = 'none'; // Hide the button after saving
        });

        generateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const topic = topicInput.value.trim();
            if (!topic) {
                alert("Please enter a topic to generate an article.");
                return;
            }

            loadingSpinner.classList.remove('hidden');
            generatedContent.classList.add('hidden');
            generatedHeadline.textContent = '';
            generatedSummary.textContent = '';
            saveArticleButton.style.display = 'none';

            const systemPrompt = `Act as a world-class investigative journalist for FreeState Press. Your task is to write a detailed, multi-paragraph news article based on the user's prompt. The article should be well-structured with a catchy headline, an introduction, and several body paragraphs.`;
            const userQuery = `Write a comprehensive news article about: "${topic}".`;

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const delay = ms => new Promise(res => setTimeout(res, ms));
            const maxRetries = 3;

            const callApi = async (retries = 0) => {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retries < maxRetries) {
                            console.warn(`Rate limit hit, retrying in ${retries + 1}s...`);
                            const backoffTime = Math.pow(2, retries) * 1000;
                            await delay(backoffTime);
                            return callApi(retries + 1);
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const fullArticleText = candidate.content.parts[0].text;
                        const lines = fullArticleText.split('\n').filter(line => line.trim() !== '');

                        // The first line is the headline, the rest is the content
                        const headline = lines[0];
                        const content = lines.slice(1).join('\n\n');
                        
                        generatedHeadline.textContent = headline;
                        generatedSummary.textContent = content;
                        generatedContent.classList.remove('hidden');
                        saveArticleButton.style.display = 'block';

                    } else {
                        throw new Error('Invalid API response format.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    generatedHeadline.textContent = 'Error generating content.';
                    generatedSummary.textContent = 'Please try again.';
                    generatedContent.classList.remove('hidden');
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            };
            
            await callApi();
        });
    });
</script>
<!-- BLOCK END: JavaScript Section -->
</html>
